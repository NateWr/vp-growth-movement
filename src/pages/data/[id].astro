---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { columns, data, rows, ticks } from '../../data/chart-config.json'
import filters from '../../data/filters.json'
import Button from '../../components/Button.vue';
import Chart from '../../components/Chart.vue';
import SketchBox from '../../components/SketchBox.astro'
import { getFilterOptions, getFilterNames } from '../../utilities/getFilterNames';
import IconArrowUpRight from '../../components/IconArrowUpRight.vue';
import { astroGetStoriesByEvent } from '../../utilities/astro-utilities';

export async function getStaticPaths() {
  const events = await getCollection('events');
  return events.map(event => ({
    params: { id: event.id },
    props: { event },
  }));
}

const { event } = Astro.props;

const country = getFilterOptions(event.data.country, filters.country)
const areas = getFilterOptions(event.data.area, filters.area)
const campaigns = getFilterOptions(event.data.campaign, filters.campaign)
const targets = getFilterOptions(event.data.target, filters.target)
const date = (new Date(event.data.date)).toLocaleDateString(
  'en-US',
  {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }
)

const stories = await astroGetStoriesByEvent(event.id)
---
<Layout
	title={event.data.headline}
	description={event.data.summary}
	currentUrl="/data"
	bgColor="white"
>
  <div
    class={`
      flex flex-col
      xl:grid xl:grid-cols-9 xl:gap-4
    `}
  >

    <div
      class={`
        sticky
        top-(--header-height)
        flex
        flex-col
        z-10
        xl:col-span-4
        2xl:col-span-5
      `}
    >
      <div class={`
        bg-black
        h-32
        sm:h-40
        md:h-48
        lg:h-64
        xl:h-40
        2xl:h-60
        4xl:h-80
      `}>
        <Chart
          client:only="vue"
          columns={columns}
          datasets={[
            {
              id: 'all-data',
              hexes: data,
              style: {
                fill: 'var(--color-chart)',
              },
            },
          ]}
          highlightEvent={event.data}
          rows={rows}
          showAllYears={false}
          storyPointsScale={5}
          ticks={ticks}
        />
      </div>
      <a
        href="/data"
        class={`
          hidden relative items-center gap-2 px-4 py-2 font-bold uppercase bg-black text-white
          md:inline-flex md:self-end
        `}
      >
        <IconArrowUpRight aria-hidden="true" />
        <span class="relative top-[1px]">All Events</span>
      </a>
    </div>

    <article
      class={`
        flex flex-col gap-4 p-4
        md:p-8 md:gap-8
        xl:col-span-5
        2xl:col-span-4
        3xl:p-16
        3xl:gap-12
      `}
    >
      <div class="
        flex flex-col gap-4
        2xl:col-span-3
        3xl:gap-8
      ">
        <div class="
          flex flex-col items-start
        ">
          <div class="
            font-semibold uppercase mb-2 text-blue
            md:text-lg
            3xl:text-xl 3xl:mb-4
          ">
            {date}
          </div>
          <h1
            class="
              text-xl font-bold
              md:text-2xl
              3xl:text-3xl
            "
          >
            {event.data.headline}
          </h1>
          {!!country.length && (
            <div class="px-2 bg-yellow md:text-lg 3xl:text-2xl">
              {event.data.city && (
                <span>
                  {event.data.city},
                </span>
              )}
              <span>
                {country.map(country => country.name).join(', ')}
              </span>
            </div>
          )}
        </div>
        <div class="
          text-lg
          md:text-xl
          3xl:text-2xl
          3xl:leading-relaxed
        ">
          {event.data.summary}
        </div>
      </div>
      {stories.map(story => (
        <div class="self-start leading-tight md:text-lg">
          <SketchBox
            backgroundPathId="panel-bg-2"
            class={`
              p-4
              transition-all
              bg-blue
              text-white
              hover:bg-red
              hover:-translate-y-1
              hover:scale-105
              hover:-rotate-1
              md:gap-6
              xl:gap-8
            `}
          >
          This event is featured in
          <a href={`/${story.id}`} class="font-bold underline">{story.data.prefix} {story.data.title}</a>.
        </div>
      ))}
      {!!event.data.sources.length && (
        <div class="flex flex-wrap gap-2 md:text-lg 3xl:text-xl">
          <div class="font-bold uppercase">Details:</div>
          {event.data.sources.map(source => (
            <a href={source.url} class="underline break-all" target="_blank">
              {source.domain}
            </a>
          ))}
        </div>
      )}
      <div class="
        flex flex-wrap gap-1
      ">
        {areas.map(area => (
          <Button href={`/data?a=${area.value}`} size="sm" class="md:text-lg">{area.name}</Button>
        ))}
        {campaigns.map(campaign => (
          <Button href={`/data?cmp=${campaign.value}`} size="sm" class="md:text-lg">{campaign.name}</Button>
        ))}
        {targets.map(target => (
          <Button href={`/data?t=${target.value}`} size="sm" class="md:text-lg">{target.name}</Button>
        ))}
      </div>
    </article>

    <div
      class={`
        mt-24
        flex
        flex-col
        gap-1
        p-4
        max-w-100
        z-10
        md:p-8
        xl:fixed
        xl:bottom-4
        xl:left-4
      `}
    >
      <hr class="mb-4 w-3/5 border-2 border-black" />
      <h2 class="text-lg font-bold uppercase">What is this?</h2>
      <p class="leadin-relaxed">This event is part of a database on the growth of the Palestinian-led, global Boycott, Divestment, and Sanctions (BDS) movement for freedom, justice, and equality.</p>
      <p class="mt-2">
        <a class="font-semibold underline" href="/">Learn more</a>
        or
        <a class="font-semibold underline" href="/data">view all data</a>.
      </p>
    </div>
  </div>

</Layout>